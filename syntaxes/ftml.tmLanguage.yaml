$schema: https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json
name: FTML/Wikidot Code
patterns:
  - include: '#comment'
  - include: '#css-block'
  - include: '#css-module-block'
  - include: '#html-block'
  - include: '#math-block'
  - include: '#attribute'
  # - include: '#block-standalone'
  # - include: '#block-standalone-value'
  - include: '#block-standalone-value-map'
  - include: '#block-standalone-map'
  - include: '#block-begin'
  # - include: '#block-begin-value'
  - include: '#block-begin-value-map'
  - include: '#block-begin-map'
  - include: '#block-end'
  - include: '#blocks-align-begin'
  - include: '#blocks-align-end'
  - include: '#header'
  - include: '#page-variables'
  - include: '#user-variables'
  - include: '#deprecated-variables'
repository:
  attribute:
    patterns:
      - name: meta.attribute.style.ftml
        begin: style(?![\w:-])
        beginCaptures:
          '0':
            name: entity.other.attribute-name.ftml
        end: (?=\s*+[^=\s])
        patterns:
          - name: meta.embedded.line.css
            begin: '='
            beginCaptures:
              '0':
                name: punctuation.separator.key-value.ftml
            end: (?<=(?<=[^\\=])\")(?=[\s\]]*)
            patterns:
              - name: string.quoted.double.ftml
                begin: '"'
                beginCaptures:
                  '0':
                    name: punctuation.definition.string.begin.ftml
                end: (")
                endCaptures:
                  '0':
                    name: punctuation.definition.string.end.ftml
                  '1':
                    name: source.css-ignored-vscode
                contentName: source.css
                pattern:
                  - include: source.css
      - match: (\S+?)\s*(=)\s*((\")(?:[^"]|\\")*((\")))
        captures:
          '1':
            name: entity.other.attribute-name.ftml
          '2':
            name: punctuation.separator.key-value.ftml
          '3':
            name: string.quoted.double.ftml
          '4':
            name: punctuation.definition.string.begin.ftml
          '5':
            name: punctuation.definition.string.end.ftml
          '6':
            name: source.css-ignored-vscode
        name: meta.attribute.$1.ftml
  comment:
    name: comment.block.ftml
    begin: \[\!\-\-
    end: \-\-\]
  css-block:
    name: markup.inserted.text.css
    begin: (?i)(\[\[)\s*(css)\s*(\]\])
    beginCaptures:
      '1':
        name: punctuation.definition.tag.begin.ftml
      '2':
        name: entity.name.tag.ftml
      '3':
        name: punctuation.definition.tag.end.ftml
    end: (?i)((\[\[)\s*\/)\s*(css)\s*(\]\])
    endCaptures:
      '1':
        name: punctuation.definition.tag.begin.ftml
      '2':
        name: source.css-ignored-vscode
      '3':
        name: entity.name.tag.ftml
      '4':
        name: punctuation.definition.tag.end.ftml
    contentName: meta.embedded.block.css
    patterns:
      - include: source.css
  css-module-block:
    name: markup.inserted.text.css
    begin: (?i)(\[\[)\s*(module css)\s*(\]\])
    beginCaptures:
      '1':
        name: punctuation.definition.tag.begin.ftml
      '2':
        name: entity.name.tag.ftml
      '3':
        name: punctuation.definition.tag.end.ftml
    end: (?i)((\[\[)\s*\/)\s*(module)\s*(\]\])
    endCaptures:
      '1':
        name: punctuation.definition.tag.begin.ftml
      '2':
        name: source.css-ignored-vscode
      '3':
        name: entity.name.tag.ftml
      '4':
        name: punctuation.definition.tag.end.ftml
    contentName: meta.embedded.block.css
    patterns:
      - include: source.css
  html-block:
    name: markup.inserted.text.html
    begin: (?i)(\[\[)\s*(html)\s*(\]\])
    beginCaptures:
      '1':
        name: punctuation.definition.tag.begin.ftml
      '2':
        name: entity.name.tag.ftml
      '3':
        name: punctuation.definition.tag.end.ftml
    end: (?i)((\[\[)\s*\/)\s*(html)\s*(\]\])
    endCaptures:
      '1':
        name: punctuation.definition.tag.begin.ftml
      '2':
        name: source.css-ignored-vscode
      '3':
        name: entity.name.tag.ftml
      '4':
        name: punctuation.definition.tag.end.ftml
    contentName: meta.embedded.block.html
    patterns:
      - include: text.html.basic
  math-block:
    name: markup.inserted.math.display.ftml
    begin: (?i)(\[\[)\s*(math)\s*(\]\])
    beginCaptures:
      '1':
        name: punctuation.definition.tag.begin.ftml
      '2':
        name: entity.name.tag.ftml
      '3':
        name: punctuation.definition.tag.end.ftml
    end: (?i)((\[\[)\s*\/)\s*(math)\s*(\]\])
    endCaptures:
      '1':
        name: punctuation.definition.tag.begin.ftml
      '2':
        name: source.css-ignored-vscode
      '3':
        name: entity.name.tag.ftml
      '4':
        name: punctuation.definition.tag.end.ftml
    contentName: meta.embedded.block.katex
    patterns:
      - include: text.katex
  block-standalone:
    name: meta.block.structure.standalone.ftml
    match: (?i)(\[\[)\s*()\s*(\]\])
    captures:
      '1':
        name: punctuation.definition.tag.begin.ftml
      '2':
        name: entity.name.tag.ftml
      '3':
        name: punctuation.definition.tag.end.ftml
  block-standalone-value:
    name: meta.block.structure.standalone.ftml
    match: (?i)(\[\[)\s*()\s+([^\s\]]+)(?=\s|\])\s*(\]\])
    captures:
      '1':
        name: punctuation.definition.tag.begin.ftml
      '2':
        name: entity.name.tag.ftml
      '3':
        name: string.other.value.ftml
      '4':
        name: punctuation.definition.tag.end.ftml
  block-standalone-value-map:
    name: meta.block.structure.standalone.ftml
    begin: >-
      (?i)(\[\[)\s*(char|character|checkbox|\*checkbox|date|embed|equation|eref|eqref|iframe|image|=image|<image|>image|f<image|f>image|include-elements|include-messy|lines|newlines|radio|radio-button|\*radio|\*radio-button|user|\*user)\s+([^\s\]]+)(?=\s|\])
    beginCaptures:
      '1':
        name: punctuation.definition.tag.begin.ftml
      '2':
        name: entity.name.tag.ftml
      '3':
        name: string.other.value.ftml
    end: \]\]
    endCaptures:
      '0':
        name: punctuation.definition.tag.end.ftml
    patterns:
      - include: '#attribute'
  block-standalone-map:
    name: meta.block.structure.standalone.ftml
    begin: (?i)(\[\[)\s*(footnoteblock|toc|f<toc|f>toc)(?=\s|\])
    beginCaptures:
      '1':
        name: punctuation.definition.tag.begin.ftml
      '2':
        name: entity.name.tag.ftml
    end: \]\]
    endCaptures:
      '0':
        name: punctuation.definition.tag.end.ftml
    patterns:
      - include: '#attribute'
  block-begin:
    name: meta.block.structure.begin.ftml
    match: (?i)(\[\[)\s*(css|footnote|html|tabview|tabs)\s*(\]\])
    captures:
      '1':
        name: punctuation.definition.tag.begin.ftml
      '2':
        name: entity.name.tag.ftml
      '3':
        name: punctuation.definition.tag.end.ftml
  block-begin-value:
    name: meta.block.structure.standalone.ftml
    match: (?i)(\[\[)\s*()\s+([^\s\]]+)(?=\s|\])\s*(\]\])
    captures:
      '1':
        name: punctuation.definition.tag.begin.ftml
      '2':
        name: entity.name.tag.ftml
      '3':
        name: string.other.value.ftml
      '4':
        name: punctuation.definition.tag.end.ftml
  block-begin-value-map:
    name: meta.block.structure.begin.ftml
    begin: >-
      (?i)(\[\[)\s*(ifcategory|iftags|math|module|module654|size|tab)\s+([^\s\]]+)(?=\s|\])
    beginCaptures:
      '1':
        name: punctuation.definition.tag.begin.ftml
      '2':
        name: entity.name.tag.ftml
      '3':
        name: string.other.value.ftml
    end: \]\]
    endCaptures:
      '0':
        name: punctuation.definition.tag.end.ftml
    patterns:
      - include: '#attribute'
  block-begin-map:
    name: meta.block.structure.begin.ftml
    begin: >-
      (?i)(\[\[)\s*(anchor_|a_|anchor|a|\*anchor_|\*a_|\*anchor|\*a|blockquote|quote|bold|b|strong|code|collapsible|del|deletion|div_|div|hidden|ins|insertion|invisible|italics|i|em|emphasis|ol_|ol|ul_|ul|li_|li|mark|highlight|monospace|tt|mono|paragraph|p|span_|span|strikethrough|s|subscript|sub|superscript|sup|super|table|cell|hcell|row|underline|u)(?=\s|\])
    beginCaptures:
      '1':
        name: punctuation.definition.tag.begin.ftml
      '2':
        name: entity.name.tag.ftml
    end: \]\]
    endCaptures:
      '0':
        name: punctuation.definition.tag.end.ftml
    patterns:
      - include: '#attribute'
  block-end:
    name: meta.block.structure.end.ftml
    match: >-
      (?i)((\[\[)\s*\/)\s*(anchor_|a_|anchor|a|blockquote|quote|bold|b|strong|code|collapsible|css|del|deletion|div_|div|footnote|hidden|html|ifcategory|iftags|ins|insertion|invisible|italics|i|em|emphasis|ol_|ol|ul_|ul|li_|li|mark|highlight|math|module|module654|monospace|tt|mono|paragraph|p|size|span_|span|strikethrough|s|subscript|sub|superscript|sup|super|table|tabview|tabs|tab|cell|hcell|row|underline|u)\s*(\]\])
    captures:
      '1':
        name: punctuation.definition.tag.begin.ftml
      '2':
        name: source.css-ignored-vscode
      '3':
        name: entity.name.tag.ftml
      '4':
        name: punctuation.definition.tag.end.ftml
  blocks-align-begin:
    name: meta.block.structure.begin.ftml
    match: (\[\[)\s*(\<|\>|\=|\=\=)\s*(\]\])
    captures:
      '1':
        name: punctuation.definition.tag.begin.ftml
      '2':
        name: entity.name.tag.ftml
      '3':
        name: punctuation.definition.tag.end.ftml
  blocks-align-end:
    name: meta.block.structure.end.ftml
    match: ((\[\[)\s*\/)\s*(\<|\>|\=|\=\=)\s*(\]\])
    captures:
      '1':
        name: punctuation.definition.tag.begin.ftml
      '2':
        name: source.css-ignored-vscode
      '3':
        name: entity.name.tag.ftml
      '4':
        name: punctuation.definition.tag.end.ftml
  blockquote:
    name: markup.quote.ftml
    match: ^(\>+)(?=\s)
    captures:
      '1':
        name: punctuation.definition.quote.ftml
  header:
    name: markup.header.ftml
    match: ^(\+{1,6})(?=\s)
    captures:
      '1':
        name: punctuation.definition.header.ftml
  page-variables:
    match: >-
      \%\%((crea|upda|commen)ted_(at|by|by_(unix|id|linked))|(parent_)?((full)?name|category|titl(e|e_linked))|link|content(\{\d+\})?|preview(\(\d+\))|summary|first_paragraph|_?tags(_linked(\|.+)?)?|form_(data|raw|label|hint)(\{.+\})?|children|comments|size|rating(_votes|_percent)|revisions|index|total|limit|total_or_limit|site_(title|name|domain))\%\%
    captures:
      '1':
        name: entity.name.variable.ftml
    name: variable.other.ftmlmodules.$1.ftml
  user-variables:
    match: >-
      \{\$.+\}
    captures:
      '1':
        name: entity.name.variable.ftml
    name: variable.other.ftmlmodules.$1.ftml
  deprecated-variables:
    match: >-
      \%\%(linked_title|page_unix_name|(full_)?page_name|author|date|(author|user|date)_edited|description|short|text|long|body)\%\%
    name: invalid.deprecated.variable.other.ftmlmodules.$1.ftml
scopeName: text.ftml
